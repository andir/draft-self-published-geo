<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
    <!ENTITY rfc1035 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.1035.xml">
    <!ENTITY rfc2119 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
    <!ENTITY rfc2616 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2616.xml">
    <!ENTITY rfc2818 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2818.xml">
    <!ENTITY rfc3629 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3629.xml">
    <!ENTITY rfc3912 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3912.xml">
    <!ENTITY rfc4180 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4180.xml">
    <!ENTITY rfc4291 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4291.xml">
    <!ENTITY rfc4408 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4408.xml">
    <!ENTITY rfc4632 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4632.xml">
    <!ENTITY rfc5952 PUBLIC ""
      "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5952.xml">
]>

<rfc category="exp"
     ipr="trust200902"
     docName="draft-self-published-geo-00">

<?xml-stylesheet type="text/xsl" href="rfc2629.xslt" ?>

<?rfc toc="yes" ?>
<?rfc symrefs="yes" ?>
<?rfc sortrefs="yes"?>
<?rfc iprnotified="no" ?>
<?rfc strict="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>

  <front>
    <title>Self-published IP Geolocation Data</title>

    <author initials="E." surname="Kline" fullname="Erik Kline">
      <organization>Google Japan</organization>
      <address>
        <postal>
          <street>Roppongi 6-10-1, 26th Floor</street>
          <city>Minato</city>
          <region>Tokyo</region>
          <code>106-6126</code>
          <country>Japan</country>
        </postal>

        <phone>+81 03 6384 9000</phone>

        <email>ek@google.com</email>
      </address>
    </author>

    <author initials="K." surname="Duleba" fullname="Krzysztof Duleba">
      <organization>Google Switzerland GmbH</organization>
      <address>
        <postal>
          <street>Brandschenkestrasse 110</street>
          <code>8002</code>
          <city>Zürich</city>
          <country>Switzerland</country>
        </postal>

        <email>kduleba@google.com</email>
      </address>
    </author>

    <author initials="Z." surname="Szamonek" fullname="Zoltan Szamonek">
      <organization>Google Switzerland GmbH</organization>
      <address>
        <postal>
          <street>Brandschenkestrasse 110</street>
          <code>8002</code>
          <city>Zürich</city>
          <country>Switzerland</country>
        </postal>

        <email>zszami@google.com</email>
      </address>
    </author>

    <date/>

    <abstract>
<t>TODO(ek): proper IPR selection</t>
<t>TODO(ek): add Krzysztof's code</t>
<t>TODO(ek): spell check!</t>
      <t>
This document records a format whereby a network operator can publish a
mapping of IP address ranges to simplified geolocation information,
colloquially termed a geolocation "feed".  Interested parties can poll and
parse these feeds to update or merge with other geolocation data sources and
procedures.
      </t>
      <t>
Some technical organizations operating networks that move from one meeting
location to the next have already experimentally published small geolocation
feeds.  At least one consumer (Google) has incorporated these ad hoc feeds
into a geolocation data pipeline.
      </t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <section title="Motivation">
        <t>
Providers of services over the Internet have grown to depend on best-effort
geolocation information to improve the user experience.  Locality information
can aid in directing traffic to the nearest serving location, inferring likely
native language, and providing additional context for services involving
search queries.
        </t>
        <t>
When a network provider changes the location of an IP prefix, services which
may use of geolocation information may begin to suffer worse performance.
This can lead to customer complaints, possibly to the network provider
directly.  Resolution of incorrect geolocation data is complicated by the
lack of any centralized means to coordinate and communicate location
information to all interested consumers of the data.
        </t>
        <t>
This document records a format whereby a network operator can publish a
mapping of IP address ranges to simplified geolocation information,
colloquially termed a "geolocation feed".  Interested parties can poll and
parse these feeds to update or merge with other geolocation data sources and
procedures.
        </t>
        <t>
Some technical organizations operating networks that move from one meeting
location to the next have already experimentally published small geolocation
feeds.  At least one consumer (Google) has incorporated these ad hoc feeds
into a geolocation data pipeline.
        </t>
      </section>

      <section title="Requirements notation">
        <t>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be
interpreted as described in <xref target="RFC2119"/>.
        </t>
      </section>

      <section title="Acceptable use implied">
        <t>
This proposal does not incorporate a mechanism to communicate acceptable
use policies for self-published data.  Publication itself is inferred as
a desire by the publisher for the data to be usefully consumed, similar
to the publication of information like hostnames, cryptographic keys, and
SPF records <xref target="RFC4408"/> in the DNS.
        </t>
      </section>
    </section>

    <section title="Self-published IP geolocation feeds">
      <t>
The format described here was developed to address the need of network
operators to rapidly and usefully share geolocation information changes.
Originally, there arose a specific case where regional operators found it
desirable to publish location changes rather than wait for geolocation
algorithms to "learn" about them.  Later on technical conferences, which
frequently use the same network prefixes advertised from different meeting
locations, experimented by publishing geolocation changes in advance
of need in order to better serve conference attendees.
      </t>
      <t>
At its simplest, the mechanism consists of a network provider publishing a
file (the "geolocation feed"), which contains several text entries, one per
line.  Each entry is keyed by a unique (within the feed) IP prefix (or single
IP address) followed by a sequence of network locality attributes to be
ascribed to the given prefix.
      </t>

      <section title="Specification">
        <t>
For operational simplicity, every feed should contain data about all IP
addresses the provider wants to publish.  Alternatives, like publishing
only entries for IP addresses whose geolocation data has changed or differ
from current observed geolocation behavior "at large", are likely to be too
operationally complex.
        </t>
        <t>
Feeds MUST use UTF-8 <xref target="RFC3629"/> character encoding.
Text after a '#' character is treated as a comment only and ignored.
Blank lines are similarly ignored.
        </t>
        <t>
Feeds MUST be in comma separated values format as described in
<xref target="RFC4180"/>.  Each feed entry is a text line of the form:
          <figure>
            <artwork>
    ip_range,country,region,city,postal_code
            </artwork>
          </figure>
        </t>
        <t>
IP range fields are REQUIRED, all others are OPTIONAL (can be empty),
though the requisite minimum number of commas SHOULD be present.
        </t>

        <section title="Geolocation feed individual entry fields">
          <section title="IP Range">
            <t>
Mandatory.  Each IP range field MUST be either a single IP address or an
IP prefix in CIDR notation in conformance with
<eref target="http://tools.ietf.org/html/rfc4632#section-3.1">section 3.1</eref>
of <xref target="RFC4632"/> for IPv4 or
<eref target="http://tools.ietf.org/html/rfc4291#section-2.3">section 2.3</eref>
of <xref target="RFC4291"/> for IPv6.
            </t>
            <t>
Examples include "192.0.2.1" and "192.0.2.0/24" for IPv4 and "2001:db8::1"
and "2001:db8::/32" for IPv6.  Additionally, IPv4 ranges (only) may be
expressed in form "192.0.2.3-192.0.2.25".
            </t>
          </section>

          <section title="Country">
            <t>
OPTIONAL.  The country field SHOULD be a 2 letter ISO country code conforming
to ISO 3166-1 alpha 2 <xref target="ISO.3166.1"/>.  Parsers should treat this
field case-insensitively.
            </t>
            <t>
Empty country fields or a country identifier of "ZZ" indicate either
unassigned reserved IP ranges or IP ranges for which existing geolocation
information can, from the perspective of the publisher, safely be discarded.
<xref target="consumers"/> contains advice to consumers of this data.
            </t>
            <t>
Examples include "US" for the United States, "JP" for Japan, and "PL" for
Poland.
            </t>
          </section>

          <section title="Region">
            <t>
OPTIONAL.  The region field should be a ISO region code conforming to
ISO 3166-2 <xref target="ISO.3166.2"/>.  Parsers should treat this field
case-insensitively.
            </t>
            <t>
Examples include "ID-RI" for the Riau province of Indonesia and "NG-RI" for
the Rivers province in Nigeria.
            </t>
          </section>

          <section title="City">
            <t>
OPTIONAL.  The city field should be free text, excluding comma (',').
            </t>
            <t>
Examples include "Dublin", "New York", and "São Paulo", specifically
"S" followed by 0xc3, 0xa3, and "o Paulo".
            </t>
          </section>

          <section title="Postal code">
            <t>
OPTIONAL.  The postal code field should be free text, excluding comma (',').
            </t>
            <t>
Examples include "106-6126" (in Minato ward, Tokyo, Japan).
            </t>
          </section>
        </section>

        <section title="Parsing and matching">
          <t>
Entries with expected fields which fail to parse, either in part or in full,
SHOULD be discarded.  It is RECOMMENDED that they also be logged for further
administrative review.  For compatibility with future additional fields a
parser MUST ignore any fields beyond those it expects.  The data from
fields which are expected and which parse successfully MUST still be
considered valid.
          </t>
          <t>
When parsing and matching, consumers MUST NOT attempt to use simple string
matching or regular expressions but instead MUST parse IP address and CIDR
string representations into IP prefixes and perform set membership tests.
While publishers SHOULD follow <xref target="RFC5952"/> style for IPv6
addresses, consumers MUST nevertheless accept all valid string representations.
          </t>
          <t>
Multiple entries which constitute nested prefixes are permitted.  Consumers
SHOULD consider the entry with the longest matching prefix (i.e. the
"most specific") to be the best matching entry for any given IP address.
          </t>
          <t>
Duplicate IP address or prefix entries SHOULD be considered an error, and
consumer implementations SHOULD log the repeated entries for further
administrative review and MAY either discard or overwrite prior duplicate
entries with subsequent data.  Publishers MUST NOT rely upon any individual
implementation's behavior and instead SHOULD take measures to ensure there is
one and only one entry per IP address and per prefix.
          </t>
        </section>
      </section>

      <section title="Examples">
        <t>
Example entries using different IP address formats and describing locations
at country, region, city and postal code granularity level, respectively:
          <figure>
            <artwork>
    192.0.2.0/25,US,US-AL,,
    192.0.2.5,US,US-AL,Alabaster,
    192.0.2.128/25,PL,PL-MZ,,02-784
    2001:db8::/32,PL,,,
    2001:db8:cafe::/48,PL,PL-MZ,,02-784
            </artwork>
          </figure>
        </t>

        <t>
Experimentally, RIPE has published geolocation information for their meeting
network prefixes, which change location in accordance with each new meeting.
<xref target="GEO_RIPE_NCC"/> at the time of writing contains:
          <figure>
            <artwork>
    193.0.24.0/21,IE,IE-D,Dublin,
    2001:67c:64::/48,IE,IE-D,Dublin,
            </artwork>
          </figure>
        </t>

        <t>
Similarly, ICANN has published geolocation information for their portable
meeting network prefixes.  <xref target="GEO_ICANN"/> at the time of writing
contains:
          <figure>
            <artwork>
    199.91.192.0/21,US,US-CA,Los Angeles,
    2620:f:8000::/48,US,US-CA,Los Angeles,
            </artwork>
          </figure>
        </t>
      </section>

      <section title="Proposed extensions">
        <t>
Already some discussions have resulted in proposed extensions.  While the
purpose of this document is principally to record existing implementation
details, it may be that there is a larger desire to publish other "network
attributes" in a similar manner.  One such network attribute, "delegation
size", is not currently implemented but the state of the proposed
extension is recorded here to demonstrate the flexibility required of
parser implementations.
        </t>

        <section title="Delegation size">
          <t>
OPTIONAL.  A publisher may optionally communicate the average delegated
prefix size for subnetworks within the IP prefix of this entry.  For a network
operator this can be used to help consumers distinguish IP prefixes among
various use types such as residential prefixes, allocations to businesses,
or data center customer allocations.
          </t>
          <t>
Non-empty strings MUST be of the form required for CIDR notation suffixes,
i.e. "/" followed by the integer prefix length of the expected allocation
to the subnetworks from within the entry's prefix.  In the absence of data
to the contrary, it is common to assume that leaf networks may be delegated
a prefix ranging from /24 to /32 in IPv4 and /48 to /64 in IPv6.  Default
assumptions about delegation size are left to the consumer's implementation.
          </t>
          <t>
Examples include "/48", "/56", "/60", and "/64".
          </t>
        </section>

        <section title="IPv4 hyphenated range format">
          <t>
OPTIONAL.  Due to the density of some IPv4 allocations in some networks it
may be more convenient to list IP ranges in an alternate, hyphenated form.
IPv4 ranges, and only IPv4 ranges, MAY be formatted as
"start_address-end_address", indicating that all IPv4 addresses from the
start address incrementing numerically through the end address inclusive
constitute the IP range for the given entry.
          </t>
          <t>
Publishers MUST prefer CIDR notation over this hyphenated alternative if a
collection of CIDR IP ranges can reasonably be constructed that expresses
the equivalent of the hyphenated range.
          </t>
          <t>
Due of the complexity of constructing a valid IP range and address mapping
to geolocation entries, this hyphenated form has some additional restrictions:
            <list style="symbols">
              <t>
All IPv4 hyphenated ranges MUST be disjoint with each other (no overlapping
ranges).
              </t>
              <t>
All IPv4 hyphenated ranges MUST be a proper subset of any covering IPv4 CIDR
prefix (no cutting across CIDR boundaries).
              </t>
            </list>
          </t>
          <t>
Examples include expressions of the form "192.0.2.3-192.0.2.25".
          </t>
        </section>
      </section>
    </section>

    <section title="Finding self-published IP geolocation feeds">
      <t>
The issue of finding, and later verifying, geolocation feeds is not
specifically addressed in this document.  At this time, only ad hoc feed
location and verification has a modicum of established practice (see below).
Regardless, both the ad hoc mechanics and a few proposed but not yet
implemented alternatives are discussed.
      </t>

      <section title="Ad hoc 'well known' URIs">
        <t>
To date, geolocation feeds have been shared informally in the form of HTTP
URIs exchanged in email threads.  The two example URIs documented above
describe networks that change locations periodically, the operators and
operational practices of which are well known within their respective
technical communities.
        </t>
        <t>
The contents of the feeds are verified by a similarly ad hoc process
including:
          <list style="symbols">
            <t>
personal knowledge of the parties involved in the exchange, and
            </t>
            <t>
comparison of feed-advertised prefixes with the BGP-advertised prefixes
of Autonomous System Numbers known to be operated by the publishers.
            </t>
          </list>
        </t>
        <t>
Ad hoc mechanisms, while useful for early experimentation by producers and
consumers, are unlikely to be adequate for long-term, widespread use by
multiple parties.  Future versions of any such self-published geolocation
feed mechanism SHOULD address scalability concerns by incorporating a means
for automated discovery and verification of operational authority of
advertised prefixes.
        </t>
      </section>

      <section title="Using public databases of network authority">
        <t>
One possibility for enabling automation would be publication of feed URIs as
a well-known attribute in public databases of network authority, e.g. the
whois service (<xref target="RFC3912"/>) operated by RIRs.  Verification
may be performed if the same or similarly authoritative service provides the
identical feed URI for queries for each entry's CIDR prefix.
        </t>
        <t>
The burden of serving this data to all interested consumers, especially the
load imposed by any verification process, is not yet known.  The anticipation
of additional operational burden on the public resource of record is noted
however.
        </t>
      </section>

      <section title="Using 'reverse' DNS">
        <t>
Another possibility for automating the location and verification of a feed
is to incorporate feed URIs into the DNS, specifically the in-addr.arpa and
ip6.arpa portions of the DNS hierarchy.  A suitably formatted query for a
TXT record that would return an answer in a well-known format, e.g.
"v=1 https://example.net/ipgeo/v1.csv", could suffice.
        </t>
        <t>
Attempts to locate the geolocation feed for a given IP address would begin by
querying directly for a TXT record associated with the PTR-style name
prefixed by "_geo.". For example, 192.0.2.4 and 2001:db8::6 would cause a
TXT record request to be issued for "_geo.4.2.0.192.in-addr.arpa" and
"_geo.6.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa",
respectively.
        </t>
        <t>
If no such record exists one further query for the fully qualified domainname
of the SOA record in the authority section of the response to the previous
query, similarly prefixed with "_geo.", would be performed
("_geo.2.0.192.in-addr.arpa" and "_geo.d.0.1.0.0.2.ip6.arpa" in the examples
above).  Successfully located feed URIs could then be processed as outlined by
this document, possibly taking in to the consider the TTL of the successful
response for refresh timing information.
        </t>
        <t>
Verification of the contents of a feed would proceed in essentially the same
way.  CIDR prefixes may be verified by constructing a query for any single
address (at random) within the prefix and proceeding as above.  While not
strictly provably correct (in cases where a publisher has delegated some
portion of the advertised prefix but not excluded it from its feed), it may
nevertheless suffice for operational purposes, especially if a low-impact
on-going verification of observed client IP addresses is implemented, to
(eventually) catch any oversights.
        </t>
        <t>
This mode is untested and may prove impractical.  However, the operational
burden is more closely located with those wishing and willing to bear it, i.e.
the publishers who would likely handle serving in-addr.arpa and ip6.arpa for
the IP prefixes under their authority.
        </t>
      </section>
    </section>

    <section anchor="consumers"
             title="Consuming self-published IP geolocation feeds">
      <t>
While consumers MAY treat published feed data as a hint only and MAY choose
to prefer other sources of geolocation information for any given IP range
there are some guidelines for sensibly and effectively consuming published
feeds.
      </t>

      <section title="Feed integrity">
        <t>
The integrity of published information SHOULD be protected by securing the
means of publication, for example by using HTTP over TLS
<xref target="RFC2818"/>.  Whenever possible, consumers SHOULD prefer
retrieving geolocation feeds in a manner that guarantees integrity of the feed.
        </t>
      </section>

      <section title="Verification of authority">
        <t>
Consumers of self-published IP geolocation feeds SHOULD perform some form
of verification that the publisher is in fact authoritative for the
addresses in the feed.  The actual means of verification is dependent
upon the way in which the feed is discovered.  Ad hoc shared URIs, for example,
will likely require an ad hoc verification process.  Automated means of feed
discovery SHOULD have an accompanying automated means of verification.
        </t>
        <t>
A consumer MUST only trust geolocation information for IP addresses or ranges
for which the publisher has been verified as administratively authoritative.
All other geolocation feed entries MUST be ignored and SHOULD be logged for
further administrative review.
        </t>
      </section>

      <section title="Verification of accuracy">
        <t>
Errors and inaccuracies may occur at many levels, and publication and
consumption of geolocation data are no exceptions.  To the extent practical
consumers SHOULD take steps to verify the accuracy of published locality.
Verification methodology, resolution of discrepancies, and preference for
alternative sources of data are left to the discretion of the consumer.
        </t>
        <t>
Consumers SHOULD decide on discrepancy thresholds and SHOULD flag for
administrative review feed entries which exceed set thresholds.
        </t>
      </section>

      <section title="Refreshing feed information">
        <t>
As a publisher can change geolocation data at any time and without
notification consumers SHOULD implement mechanisms to periodically refresh
local copies of feed data.  If the feed discovery mechanism offers hints
about data validity time (e.g. the TTL field of the DNS Resource Record which
identified a feed (section 3.2.1 of <xref target="RFC1035"/>)), then the given
feed SHOULD be refreshed before the expiration of this validity timer.
        </t>
        <t>
For feeds available via HTTPS (or HTTP), the publisher MAY communicate
refresh timing information by means of the standard HTTP expiration model
(<eref target="http://tools.ietf.org/html/rfc2616#section-13.2">section
13.2</eref> of <xref target="RFC2616"/>).  Specifically, publishers can
include either an
<eref target="http://tools.ietf.org/html/rfc2616#section-14.21">Expires
header</eref> or a
<eref target="http://tools.ietf.org/html/rfc2616#section-14.9">Cache-Control
header</eref> specifying the max-age.  Where practical, consumers SHOULD
refresh feed information before the expiry time is reached.
        </t>
        <t>
In the absence of any other refresh timing information it is recommended that
consumers SHOULD refresh feeds no less often than weekly.
        </t>
      </section>
    </section>

    <section title="Security Considerations">
      <t>
As there is no true security in the obscurity of the location of any given
IP address, self-publication of this data fundamentally opens no new attack
vectors.  For publishers, self-published data merely increases the ease with
which such location data might be exploited.
      </t>
      <t>
For consumers, feed retrieval processes may receive input from potentially
hostile sources (e.g. in the event of hijacked traffic).  As such, proper
input validation and defense measures MUST be taken.
      </t>
      <t>
Similarly, consumers who do not perform sufficient verification of published
data bear the same risks as from other forms of geolocation configuration
errors.
      </t>
    </section>

    <section title="Acknowledgements">
      <t>
The authors would like to express their gratitude to reviewers and early
implementers, including but not limited to Mikael Abrahamsson,
Richard L. Barnes, Andras Erdei, Marco Hogewoning, Warren Kumari,
Menno Schepers, Justyna Sidorska, and Bjoern A. Zeeb.
      </t>
    </section>
  </middle>

  <back>
      <references title="Normative References">
&rfc2119;

&rfc2616;

&rfc3629;

&rfc4180;

&rfc4291;

&rfc4632;

<reference
 anchor="ISO.3166.1"
 target="http://www.iso.org/iso/home/standards/country_codes/iso-3166-1_decoding_table.htm">
  <front>
    <title>ISO 3166-1 decoding table</title>
    <author fullname="ISO 3166 Maintenance agency">
      <organization abbrev="ISO">
International Organization for Standardization
      </organization>
    </author>
  </front>
</reference>

<reference
 anchor="ISO.3166.2"
 target="http://www.iso.org/iso/home/standards/country_codes.htm#2012_iso3166-2"
 >
  <front>
    <title>ISO 3166-2:2007</title>
    <author fullname="ISO 3166 Maintenance agency">
      <organization abbrev="ISO">
International Organization for Standardization
      </organization>
    </author>
  </front>
</reference>
      </references>

      <references title="Informative References">
&rfc1035;

&rfc2818;

&rfc3912;

&rfc4408;

&rfc5952;

<reference target="https://meetings.ripe.net/geo/google.csv"
           anchor="GEO_RIPE_NCC">
  <front>
    <title>RIPE NCC Meeting Geolocation Data</title>
    <author fullname="Menno Schepers" initials="M." surname="Schepers">
      <organization abbrev="RIPE NCC">
Réseaux IP Européens Network Coordination Centre
      </organization>
    </author>
  </front>
</reference>

<reference target="https://registration.icann.org/geo/google.csv"
           anchor="GEO_ICANN">
  <front>
    <title>ICANN Meeting Geolocation Data</title>
    <author>
      <organization abbrev="ICANN">
Internet Corporation For Assigned Names and Numbers
      </organization>
    </author>
  </front>
</reference>
      </references>

      <section title="Sample Python validation code">
        <t>
TODO(kduleba).
        </t>
      </section>
  </back>
</rfc>
